---
import Layout from '@/layouts/Layout.astro'
---

<Layout title="Mi Perfil | La Velada del Año V">
  <section class="flex min-h-screen w-full items-center justify-center px-4 pt-24">
    <div
      id="profile-container"
      class="bg-theme-raisin-black/80 hidden w-full max-w-2xl rounded-xl border border-white/20 p-8 backdrop-blur-md"
    >
      <h1 class="mb-8 text-center text-3xl font-bold uppercase tracking-wider text-white">
        Mi Perfil
      </h1>

      <div class="grid gap-6 md:grid-cols-2">
        <div class="space-y-2">
          <p class="text-sm font-medium text-gray-400">Nombre de Usuario</p>
          <p id="profile-username" class="break-words text-xl font-bold text-white"></p>
        </div>

        <div class="space-y-2">
          <p class="text-sm font-medium text-gray-400">Email</p>
          <p id="profile-email" class="break-all text-xl font-bold text-white"></p>
        </div>
      </div>

      <div class="mt-12 flex justify-center">
        <button
          id="logout-btn"
          class="rounded-lg border border-red-500 px-6 py-2 text-red-500 transition-colors hover:bg-red-500 hover:text-white focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-900"
        >
          CERRAR SESIÓN
        </button>
      </div>
    </div>

    <div id="loading" class="animate-pulse text-xl text-white">Cargando perfil...</div>
  </section>
</Layout>

<script>
  import { authService } from '@/services/auth'

  const profileContainer = document.getElementById('profile-container')
  const loading = document.getElementById('loading')
  const usernameEl = document.getElementById('profile-username')
  const emailEl = document.getElementById('profile-email')
  const logoutBtn = document.getElementById('logout-btn')

  async function loadProfile() {
    const token = authService.getToken()

    if (!token) {
      window.location.href = '/login'
      return
    }

    try {
      const profile = await authService.getProfile(token)

      if (usernameEl) usernameEl.textContent = profile.username
      if (emailEl) emailEl.textContent = profile.email

      loading?.classList.add('hidden')
      profileContainer?.classList.remove('hidden')
    } catch (error: any) {
      console.error(error)
      if (error.status === 401) {
        authService.logout()
        window.location.href = '/login'
      } else {
        if (loading) loading.textContent = 'Error al cargar perfil. Intenta recargar.'
        if (loading) loading.classList.remove('animate-pulse', 'text-white')
        if (loading) loading.classList.add('text-red-500')
      }
    }
  }

  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      authService.logout()
      window.location.href = '/'
    })
  }

  loadProfile()
</script>
