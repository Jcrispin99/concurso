---
interface Props {
    videoId?: string
    url?: string
    music_info?: number
    description?: number
    controls?: number
    autoplay?: number
    loop?: number
}

const {
    videoId,
    url,
    music_info = 1,
    description = 1,
    controls = 1,
    autoplay = 0,
    loop = 0,
} = Astro.props as Props

let postId = videoId || null
if (!postId && url) {
    const postIdMatch = url.match(/(?:video\/|player\/v1\/)(\d+)/)
    postId = postIdMatch ? postIdMatch[1] : null
}

const iframeSrc = postId
    ? `https://www.tiktok.com/player/v1/${postId}?music_info=${music_info}&description=${description}&controls=${controls}&autoplay=${autoplay}&loop=${loop}&rel=1`
    : null

const iframeId = postId ? `tiktok-iframe-${postId}` : 'tiktok-iframe'
---

<div class="tiktok-player-container">
    {
        iframeSrc ? (
        <div class="player-wrap">
            <div class="loader" id={`loader-${iframeId}`}></div>
            <iframe
            id={iframeId}
            src={iframeSrc}
            title="TikTok video"
            allow="autoplay; fullscreen"
            allowfullscreen
            loading="lazy"
            onload={`document.getElementById('loader-${iframeId}').style.display = 'none'`}
            />
        </div>
        ) : (
        <div class="embed-fallback text-center">
            <p>TikTok video not available</p>
        </div>
        )
    }
</div>

<style is:global>
    .tiktok-player-container {
        width: 100%;
        padding: 1.5rem;
        display: flex;
        justify-content: center;
        align-items: center;
        background: transparent;
    }

    .tiktok-player-container .player-wrap {
        width: 100%;
        max-width: 500px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }

    .loader {
        position: absolute;
        width: 50px;
        height: 50px;
        border: 4px solid rgba(201, 77, 138, 0.2);
        border-top-color: #c94d8a;
        border-right-color: #c94d8a;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 1;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @keyframes skeleton-loading {
        0% {
            background-position: 200% 0;
            opacity: 0.7;
        }
        50% {
            opacity: 1;
        }
        100% {
            background-position: -200% 0;
            opacity: 0.7;
        }
    }

    .tiktok-player-container iframe {
        width: 150%;
        height: 400px;
        border: 0;
        background: transparent !important;
        box-shadow: none !important;
        border-radius: 0.5rem;
        position: relative;
        z-index: 2;
    }

    @media (min-width: 768px) {
        .tiktok-player-container {
            padding: 2rem;
        }

        .tiktok-player-container .player-wrap {
            max-width: 550px;
        }
    }

    @media (min-width: 1024px) {
        .tiktok-player-container .player-wrap {
            max-width: 600px;
        }
    }

    .tiktok-player-container * {
        background: transparent !important;
    }
</style>
